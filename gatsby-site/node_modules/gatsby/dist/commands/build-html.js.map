{"version":3,"sources":["../../src/commands/build-html.js"],"names":["Promise","require","webpack","fs","convertHrtime","chunk","webpackConfig","reporter","createErrorFromString","telemetry","handleWebpackError","runWebpack","compilerConfig","resolve","reject","run","err","stats","doBuildRenderer","program","directory","outputFile","hasErrors","panic","compilation","errors","buildRenderer","stage","parentSpan","config","deleteRenderer","rendererPath","remove","e","renderHTMLQueue","workerPool","activity","htmlComponentRendererPath","pages","envVars","Object","entries","NODE_ENV","process","env","gatsby_executing_command","gatsby_log_level","start","hrtime","segments","finished","map","pageSegment","renderHTML","paths","then","length","setStatus","seconds","toFixed","catch","doBuildPages","pagePaths","decorateEvent","siteMeasurements","pagesCount","prettyError","stack","context","buildPages","span","module","exports"],"mappings":"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","sourcesContent":["/* @flow */\nconst Promise = require(`bluebird`)\nconst webpack = require(`webpack`)\nconst fs = require(`fs-extra`)\nconst convertHrtime = require(`convert-hrtime`)\nconst { chunk } = require(`lodash`)\nconst webpackConfig = require(`../utils/webpack.config`)\nconst reporter = require(`gatsby-cli/lib/reporter`)\nconst { createErrorFromString } = require(`gatsby-cli/lib/reporter/errors`)\nconst telemetry = require(`gatsby-telemetry`)\n\nconst handleWebpackError = require(`../utils/webpack-error-parser`)\n\nconst runWebpack = compilerConfig =>\n  new Promise((resolve, reject) => {\n    webpack(compilerConfig).run((err, stats) => {\n      if (err) {\n        reject(err)\n      } else {\n        resolve(stats)\n      }\n    })\n  })\n\nconst doBuildRenderer = async (program, webpackConfig) => {\n  const { directory } = program\n  const stats = await runWebpack(webpackConfig)\n  // render-page.js is hard coded in webpack.config\n  const outputFile = `${directory}/public/render-page.js`\n  if (stats.hasErrors()) {\n    reporter.panic(handleWebpackError(`build-html`, stats.compilation.errors))\n  }\n  return outputFile\n}\n\nconst buildRenderer = async (program, stage, { parentSpan }) => {\n  const { directory } = program\n  const config = await webpackConfig(program, directory, stage, null, {\n    parentSpan,\n  })\n  return await doBuildRenderer(program, config)\n}\n\nconst deleteRenderer = async rendererPath => {\n  try {\n    await fs.remove(rendererPath)\n    await fs.remove(`${rendererPath}.map`)\n  } catch (e) {\n    // This function will fail on Windows with no further consequences.\n  }\n}\n\nconst renderHTMLQueue = (\n  { workerPool, activity },\n  htmlComponentRendererPath,\n  pages\n) =>\n  new Promise((resolve, reject) => {\n    // We need to only pass env vars that are set programmatically in gatsby-cli\n    // to child process. Other vars will be picked up from environment.\n    const envVars = Object.entries({\n      NODE_ENV: process.env.NODE_ENV,\n      gatsby_executing_command: process.env.gatsby_executing_command,\n      gatsby_log_level: process.env.gatsby_log_level,\n    })\n\n    const start = process.hrtime()\n    const segments = chunk(pages, 50)\n    let finished = 0\n\n    Promise.map(\n      segments,\n      pageSegment =>\n        new Promise((resolve, reject) => {\n          workerPool\n            .renderHTML({\n              htmlComponentRendererPath,\n              paths: pageSegment,\n              envVars,\n            })\n            .then(() => {\n              finished += pageSegment.length\n              if (activity) {\n                activity.setStatus(\n                  `${finished}/${pages.length} ${(\n                    finished / convertHrtime(process.hrtime(start)).seconds\n                  ).toFixed(2)} pages/second`\n                )\n              }\n              resolve()\n            })\n            .catch(reject)\n        })\n    )\n      .then(resolve)\n      .catch(reject)\n  })\n\nconst doBuildPages = async ({\n  rendererPath,\n  pagePaths,\n  activity,\n  workerPool,\n}) => {\n  telemetry.decorateEvent(`BUILD_END`, {\n    siteMeasurements: { pagesCount: pagePaths.length },\n  })\n\n  try {\n    await renderHTMLQueue({ workerPool, activity }, rendererPath, pagePaths)\n  } catch (e) {\n    const prettyError = await createErrorFromString(\n      e.stack,\n      `${rendererPath}.map`\n    )\n    prettyError.context = e.context\n    throw prettyError\n  }\n}\n\nconst buildPages = async ({\n  program,\n  stage,\n  pagePaths,\n  activity,\n  workerPool,\n}) => {\n  const rendererPath = await buildRenderer(program, stage, {\n    parentSpan: activity.span,\n  })\n  await doBuildPages({ rendererPath, pagePaths, activity, workerPool })\n  await deleteRenderer(rendererPath)\n}\n\nmodule.exports = {\n  buildPages,\n}\n"],"file":"build-html.js"}