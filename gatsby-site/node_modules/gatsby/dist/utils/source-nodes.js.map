{"version":3,"sources":["../../src/utils/source-nodes.js"],"names":["_","require","report","apiRunner","store","getNode","getNodes","boundActionCreators","deleteNode","discoverPluginsWithoutNodes","storeState","nodeCreationPlugins","flattenedPlugins","filter","plugin","nodeAPIs","includes","name","map","nodeOwners","uniq","Array","from","reduce","acc","node","push","internal","owner","difference","module","exports","webhookBody","parentSpan","traceId","waitForCascadingActions","state","getState","pluginsWithNoNodes","warn","touchedNodes","Object","keys","nodesTouched","staleNodes","rootNode","whileCount","parent","undefined","console","log","id","length","forEach"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst report = require(`gatsby-cli/lib/reporter`)\n\nconst apiRunner = require(`./api-runner-node`)\nconst { store } = require(`../redux`)\nconst { getNode, getNodes } = require(`../db/nodes`)\nconst { boundActionCreators } = require(`../redux/actions`)\nconst { deleteNode } = boundActionCreators\n\n/**\n * Finds the name of all plugins which implement Gatsby APIs that\n * may create nodes, but which have not actually created any nodes.\n */\nfunction discoverPluginsWithoutNodes(storeState) {\n  // Discover which plugins implement APIs which may create nodes\n  const nodeCreationPlugins = storeState.flattenedPlugins\n    .filter(\n      plugin =>\n        plugin.nodeAPIs.includes(`sourceNodes`) &&\n        plugin.name !== `default-site-plugin`\n    )\n    .map(plugin => plugin.name)\n\n  // Find out which plugins own already created nodes\n  const nodeOwners = _.uniq(\n    Array.from(getNodes()).reduce((acc, node) => {\n      acc.push(node.internal.owner)\n      return acc\n    }, [])\n  )\n  return _.difference(nodeCreationPlugins, nodeOwners)\n}\n\nmodule.exports = async ({ webhookBody = {}, parentSpan } = {}) => {\n  await apiRunner(`sourceNodes`, {\n    traceId: `initial-sourceNodes`,\n    waitForCascadingActions: true,\n    parentSpan,\n    webhookBody,\n  })\n\n  const state = store.getState()\n\n  // Warn about plugins that should have created nodes but didn't.\n  const pluginsWithNoNodes = discoverPluginsWithoutNodes(state)\n  pluginsWithNoNodes.map(name =>\n    report.warn(\n      `The ${name} plugin has generated no Gatsby nodes. Do you need it?`\n    )\n  )\n\n  // Garbage collect stale data nodes\n  const touchedNodes = Object.keys(state.nodesTouched)\n  const staleNodes = Array.from(getNodes()).filter(node => {\n    // Find the root node.\n    let rootNode = node\n    let whileCount = 0\n    while (\n      rootNode.parent &&\n      getNode(rootNode.parent) !== undefined &&\n      whileCount < 101\n    ) {\n      rootNode = getNode(rootNode.parent)\n      whileCount += 1\n      if (whileCount > 100) {\n        console.log(\n          `It looks like you have a node that's set its parent as itself`,\n          rootNode\n        )\n      }\n    }\n\n    return !_.includes(touchedNodes, rootNode.id)\n  })\n\n  if (staleNodes.length > 0) {\n    staleNodes.forEach(node => deleteNode({ node }))\n  }\n}\n"],"file":"source-nodes.js"}