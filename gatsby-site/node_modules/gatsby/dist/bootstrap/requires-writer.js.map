{"version":3,"sources":["../../src/bootstrap/requires-writer.js"],"names":["_","require","fs","crypto","store","emitter","match","lastHash","resetLastHash","pickComponentFields","page","pick","getComponents","pages","map","uniqBy","c","componentChunkName","value","getMatchPaths","createMatchPathEntry","index","score","matchPath","replace","split","length","includes","matchPathPages","forEach","push","isInsideMatchPath","find","pageWithMatchPath","path","sort","a","b","order","createHash","matchPaths","components","update","JSON","stringify","digest","writeAll","state","program","values","newHash","Promise","resolve","syncRequires","component","join","asyncRequires","writeAndMove","file","data","destination","directory","tmp","Date","now","writeFile","then","move","overwrite","result","all","debouncedWriteAll","debounce","getState","leading","startListener","on","module","exports"],"mappings":"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","sourcesContent":["const _ = require(`lodash`)\nconst fs = require(`fs-extra`)\nconst crypto = require(`crypto`)\nconst { store, emitter } = require(`../redux/`)\nconst { match } = require(`@reach/router/lib/utils`)\nimport { joinPath } from \"gatsby-core-utils\"\n\nlet lastHash = null\n\nconst resetLastHash = () => {\n  lastHash = null\n}\n\nconst pickComponentFields = page =>\n  _.pick(page, [`component`, `componentChunkName`])\n\nconst getComponents = pages =>\n  _(pages)\n    .map(pickComponentFields)\n    .uniqBy(c => c.componentChunkName)\n    .value()\n\n/**\n * Get all dynamic routes and sort them by most specific at the top\n * code is based on @reach/router match utility (https://github.com/reach/router/blob/152aff2352bc62cefc932e1b536de9efde6b64a5/src/lib/utils.js#L224-L254)\n */\nconst getMatchPaths = pages => {\n  const createMatchPathEntry = (page, index) => {\n    let score = page.matchPath.replace(/\\/$/, ``).split(`/`).length\n    if (!page.matchPath.includes(`*`)) {\n      score += 1\n    }\n\n    return {\n      ...page,\n      index,\n      score,\n    }\n  }\n\n  const matchPathPages = []\n  pages.forEach((page, index) => {\n    if (page.matchPath) {\n      matchPathPages.push(createMatchPathEntry(page, index))\n    }\n  })\n\n  // Pages can live in matchPaths, to keep them working without doing another network request\n  // we save them in matchPath. Our sorting will put them above dynamic routes\n  // as we add a static bonus point to static routes\n  // More info in https://github.com/gatsbyjs/gatsby/issues/16097\n  // small speedup: don't bother traversing when no matchPaths found.\n  if (matchPathPages.length) {\n    pages.forEach((page, index) => {\n      const isInsideMatchPath = !!matchPathPages.find(\n        pageWithMatchPath =>\n          !page.matchPath && match(pageWithMatchPath.matchPath, page.path)\n      )\n\n      if (isInsideMatchPath) {\n        matchPathPages.push(\n          createMatchPathEntry(\n            {\n              ...page,\n              matchPath: page.path,\n            },\n            index\n          )\n        )\n      }\n    })\n  }\n\n  return matchPathPages\n    .sort((a, b) => {\n      // The higher the score, the higher the specificity of our matchPath\n      const order = b.score - a.score\n      if (order !== 0) {\n        return order\n      }\n\n      // if specificity is the same we use the array index\n      return b.index - a.index\n    })\n    .map(({ path, matchPath }) => {\n      return { path, matchPath }\n    })\n}\n\nconst createHash = (matchPaths, components) =>\n  crypto\n    .createHash(`md5`)\n    .update(JSON.stringify({ matchPaths, components }))\n    .digest(`hex`)\n\n// Write out pages information.\nconst writeAll = async state => {\n  const { program } = state\n  const pages = [...state.pages.values()]\n  const matchPaths = getMatchPaths(pages)\n  const components = getComponents(pages)\n\n  const newHash = createHash(matchPaths, components)\n\n  if (newHash === lastHash) {\n    // Nothing changed. No need to rewrite files\n    return Promise.resolve()\n  }\n\n  lastHash = newHash\n\n  // Create file with sync requires of components/json files.\n  let syncRequires = `const { hot } = require(\"react-hot-loader/root\")\n\n// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n\\n`\n  syncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": hot(preferDefault(require(\"${joinPath(\n          c.component\n        )}\")))`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  // Create file with async requires of components/json files.\n  let asyncRequires = `// prefer default export if available\nconst preferDefault = m => m && m.default || m\n\\n`\n  asyncRequires += `exports.components = {\\n${components\n    .map(\n      c =>\n        `  \"${c.componentChunkName}\": () => import(\"${joinPath(\n          c.component\n        )}\" /* webpackChunkName: \"${c.componentChunkName}\" */)`\n    )\n    .join(`,\\n`)}\n}\\n\\n`\n\n  const writeAndMove = (file, data) => {\n    const destination = joinPath(program.directory, `.cache`, file)\n    const tmp = `${destination}.${Date.now()}`\n    return fs\n      .writeFile(tmp, data)\n      .then(() => fs.move(tmp, destination, { overwrite: true }))\n  }\n\n  const result = await Promise.all([\n    writeAndMove(`sync-requires.js`, syncRequires),\n    writeAndMove(`async-requires.js`, asyncRequires),\n    writeAndMove(`match-paths.json`, JSON.stringify(matchPaths, null, 4)),\n  ])\n\n  return result\n}\n\nconst debouncedWriteAll = _.debounce(() => writeAll(store.getState()), 500, {\n  leading: true,\n})\n\n/**\n * Start listening to CREATE/DELETE_PAGE events so we can rewrite\n * files as required\n */\nconst startListener = () => {\n  emitter.on(`CREATE_PAGE`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`CREATE_PAGE_END`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE`, () => {\n    debouncedWriteAll()\n  })\n\n  emitter.on(`DELETE_PAGE_BY_PATH`, () => {\n    debouncedWriteAll()\n  })\n}\n\nmodule.exports = {\n  writeAll,\n  resetLastHash,\n  startListener,\n}\n"],"file":"requires-writer.js"}