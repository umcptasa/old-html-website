{"version":3,"sources":["../../src/query/query-runner.js"],"names":["fs","require","report","path","store","formatErrorDetails","boundActionCreators","pageDataUtil","resultHashes","module","exports","graphqlRunner","queryJob","program","webpackCompilationHash","getState","graphql","query","context","result","errors","errorDetails","Map","set","isPage","JSON","stringify","pluginCreatorId","panicOnBuild","componentPath","Object","assign","pageContext","internalComponentName","component","componentChunkName","updatedAt","pluginCreator___NODE","resultJSON","resultHash","createHash","update","digest","id","publicDir","join","directory","pages","page","get","write","resultPath","hash","outputFile","pageQueryRun"],"mappings":"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","sourcesContent":["// @flow\n\nconst fs = require(`fs-extra`)\nconst report = require(`gatsby-cli/lib/reporter`)\n\nconst path = require(`path`)\nconst { store } = require(`../redux`)\nconst { formatErrorDetails } = require(`./utils`)\nconst { boundActionCreators } = require(`../redux/actions`)\nconst pageDataUtil = require(`../utils/page-data`)\n\nconst resultHashes = {}\n\ntype QueryJob = {\n  id: string,\n  hash?: string,\n  query: string,\n  componentPath: string,\n  context: Object,\n  isPage: Boolean,\n}\n\n// Run query\nmodule.exports = async (graphqlRunner, queryJob: QueryJob) => {\n  const { program, webpackCompilationHash } = store.getState()\n\n  const graphql = (query, context) => graphqlRunner.query(query, context)\n\n  // Run query\n  let result\n  // Nothing to do if the query doesn't exist.\n  if (!queryJob.query || queryJob.query === ``) {\n    result = {}\n  } else {\n    result = await graphql(queryJob.query, queryJob.context)\n  }\n\n  // If there's a graphql error then log the error. If we're building, also\n  // quit.\n  if (result && result.errors) {\n    const errorDetails = new Map()\n    errorDetails.set(`Errors`, result.errors || [])\n    if (queryJob.isPage) {\n      errorDetails.set(`URL path`, queryJob.context.path)\n      errorDetails.set(\n        `Context`,\n        JSON.stringify(queryJob.context.context, null, 2)\n      )\n    }\n    errorDetails.set(`Plugin`, queryJob.pluginCreatorId || `none`)\n    errorDetails.set(`Query`, queryJob.query)\n\n    report.panicOnBuild(`\nThe GraphQL query from ${queryJob.componentPath} failed.\n\n${formatErrorDetails(errorDetails)}`)\n  }\n\n  // Add the page context onto the results.\n  if (queryJob && queryJob.isPage) {\n    result[`pageContext`] = Object.assign({}, queryJob.context)\n  }\n\n  // Delete internal data from pageContext\n  if (result.pageContext) {\n    delete result.pageContext.path\n    delete result.pageContext.internalComponentName\n    delete result.pageContext.component\n    delete result.pageContext.componentChunkName\n    delete result.pageContext.updatedAt\n    delete result.pageContext.pluginCreator___NODE\n    delete result.pageContext.pluginCreatorId\n    delete result.pageContext.componentPath\n    delete result.pageContext.context\n  }\n\n  const resultJSON = JSON.stringify(result)\n  const resultHash = require(`crypto`)\n    .createHash(`sha1`)\n    .update(resultJSON)\n    .digest(`base64`)\n\n  if (resultHashes[queryJob.id] !== resultHash) {\n    resultHashes[queryJob.id] = resultHash\n\n    if (queryJob.isPage) {\n      const publicDir = path.join(program.directory, `public`)\n      const { pages } = store.getState()\n      const page = pages.get(queryJob.id)\n      await pageDataUtil.write(\n        { publicDir },\n        page,\n        result,\n        webpackCompilationHash\n      )\n    } else {\n      // The babel plugin is hard-coded to load static queries from\n      // public/static/d/\n      const resultPath = path.join(\n        program.directory,\n        `public`,\n        `static`,\n        `d`,\n        `${queryJob.hash}.json`\n      )\n\n      await fs.outputFile(resultPath, resultJSON)\n    }\n  }\n\n  boundActionCreators.pageQueryRun({\n    path: queryJob.id,\n    componentPath: queryJob.componentPath,\n    isPage: queryJob.isPage,\n  })\n\n  return result\n}\n"],"file":"query-runner.js"}